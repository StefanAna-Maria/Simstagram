@model proiect.Models.Group

@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Group Details";
    var userId = UserManager.GetUserId(User);
    bool isCreator = Model.CreatorId == userId;
    bool isMember = Model.Members.Any(m => m.UserId == userId);
    bool hasPendingRequest = Model.PendingRequests?.Any(r => r.RequesterId == userId && r.Status == RequestStatus.Pending) ?? false;
}

<h2>@Model.Name</h2>
<p><strong>Created At:</strong> @Model.CreatedAt.ToString("g")</p>

<!-- JOIN LOGIC -->
@if (!isCreator && !isMember)
{
    if (!hasPendingRequest)
    {
        <form asp-action="RequestToJoin" asp-route-groupId="@Model.Id" method="post" class="mt-3">
            <button class="btn btn-outline-primary text-light" type="submit" style="background: #4e8885">Request to Join</button>
        </form>
    }
    else
    {
        <div class="alert alert-info mt-3">
            You have already requested to join this group. Waiting for approval.
        </div>
    }
}

<!-- MEMBERS LIST -->
<h4 class="mt-4">Members:</h4>
<ul class="list-group">
    @foreach (var member in Model.Members)
    {
        <li class="list-group-item d-flex justify-content-between align-items-center">
            @member.User.DisplayName (@member.User.Email)

            @if (Model.CreatorId == ViewBag.CurrentUserId && member.UserId != Model.CreatorId)
            {
                <form asp-controller="Group" asp-action="RemoveMember" method="post" class="mb-0">
                    <input type="hidden" name="groupId" value="@Model.Id" />
                    <input type="hidden" name="userId" value="@member.UserId" />
                    <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                </form>
            }
        </li>
    }
</ul>

<!-- ADMIN OPTIONS -->
@if (Model.CreatorId == ViewBag.CurrentUserId)
{
    <a href="@Url.Action("AddMembers", "Group", new { id = Model.Id })" class="btn btn-success mt-3" style=" background-color: #4e8885">Add Members</a>

    <a href="@Url.Action("ManageRequests", "Group", new { groupId = Model.Id })" class="btn btn-warning mt-2">Manage Join Requests</a>

    <form asp-controller="Group" asp-action="DeleteGroup" method="post" class="mt-3">
        <input type="hidden" name="groupId" value="@Model.Id" />
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this group?');">
            Delete Group
        </button>
    </form>
}


@if (Model.Members.Any(m => m.UserId == ViewBag.CurrentUserId) && Model.CreatorId != ViewBag.CurrentUserId)
{
    <form asp-action="LeaveGroup" asp-controller="Group" method="post" class="mt-3">
        <input type="hidden" name="groupId" value="@Model.Id" />
        <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to leave this group?');">
            Leave Group
        </button>
    </form>
}